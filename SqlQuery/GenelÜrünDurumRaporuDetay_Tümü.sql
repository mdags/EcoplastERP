select D.Oid, P.Oid, PG.Name as [Ürün Grubu], PT.Name as [Ürün Tipi], PK.Name as [Ürün Cinsi], PKG.Name as [Satýþ Ürün Grubu], (case when P.PrintStatus = 0 then 'Baskýlý' else 'Baskýsýz' end) as [Baský Durumu], O.OrderNumber+'/'+cast(D.LineNumber as varchar(5)) as [Sipariþ No], D.LineDeliveryDate as [Termin Tarihi], C.Name as [Sipariþi Veren], SC.Name as [Malý Teslim Alan], P.Code as [Malzeme Kodu], P.Name as [Malzeme Adý], SUM(D.cQuantity) as [Sipariþ TÖB Miktarý], (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) as [Sevk Edilen TÖB Miktar], (case when (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) > 0 then SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) else 0 end) as [Bekleyen TÖB Miktar], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid), 0) as [Depo TÖB Miktar], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Baský') and SalesOrderDetail = D.Oid), 0) as [Baský Depo], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Kesim') and SalesOrderDetail = D.Oid), 0) as [Konfeksiyon Depo], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Dilme') and SalesOrderDetail = D.Oid), 0) as [Dilme Depo], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Laminasyon') and SalesOrderDetail = D.Oid), 0) as [Laminasyon Depo], isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Balonlu Çekim') and SalesOrderDetail = D.Oid), 0) as [Cast Depo], (case when ((case when (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) > 0 then SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) else 0 end) - (isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Baský') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Kesim') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Dilme') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Laminasyon') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Balonlu Çekim') and SalesOrderDetail = D.Oid), 0))) > 0 then ((case when (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) > 0 then SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) else 0 end) - (isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Baský') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Kesim') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Dilme') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Laminasyon') and SalesOrderDetail = D.Oid), 0) + isnull((select SUM(cQuantity) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Balonlu Çekim') and SalesOrderDetail = D.Oid), 0))) else 0 end) as [Üretilecek TÖB Miktar] from SalesOrderDetail D inner join SalesOrder O on O.Oid = D.SalesOrder inner join Contact C on C.Oid = O.Contact inner join Contact SC on SC.Oid = O.ShippingContact inner join Product P on P.Oid = D.Product inner join ProductGroup PG on PG.Oid = P.ProductGroup inner join ProductType PT on PT.Oid = P.ProductType inner join ProductKind PK on PK.Oid = P.ProductKind inner join ProductKindGroup PKG on PKG.Oid = PK.ProductKindGroup where D.GCRecord is null and D.SalesOrderStatus < 200 and (PG.Code = 'OM' or PG.Code = 'SM') and PK.Oid = '{0}' group by PG.Oid, PG.Name, PT.Oid, PT.Name, PK.Oid, PK.Name, PKG.Name, P.PrintStatus, O.OrderNumber, D.LineNumber, D.LineDeliveryDate, D.Oid, P.Oid, C.Name, SC.Name, P.Code, P.Name