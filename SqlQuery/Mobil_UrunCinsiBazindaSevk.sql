select ProductKind, sum(Quantity) as Quantity, Unit, sum(Total) as Total from (select PK.Name as ProductKind, sum(D.cQuantity) as Quantity, U.Code as Unit, sum(D.cQuantity) * (case when SD.CurrencyPrice > 0 then (SD.CurrencyPrice / (case when SD.ExchangeRate > 0 then SD.ExchangeRate else 1 end)) else SD.Price end) as Total from SalesWaybillDetail D inner join SalesWaybill W on W.Oid = D.SalesWaybill inner join SalesOrderDetail SD on SD.Oid = D.SalesOrderDetail inner join Unit U on U.Oid = D.cUnit inner join Product P on P.Oid = SD.Product inner join ProductKind PK on PK.Oid = P.ProductKind where D.GCRecord is null and cast(W.WaybillDate as date) between '2017-05-17' and '2017-05-18' group by PK.Name, U.Code, SD.CurrencyPrice, SD.Price, SD.ExchangeRate) T group by ProductKind, Unit order by Total desc