select W.WaybillNumber, W.WaybillDate, O.OrderNumber+'/'+cast(SD.LineNumber as varchar(5)) as [OrderNumber], C.Name as [Contact], SC.Name as [ShippingContact], P.Name as [Product], sum(WD.Quantity) as [Quantity], U.Code as [Unit], SD.Price as [TLPrice], SUM(WD.Quantity) * SD.Price as [TLSubTotal], (case when SD.Tax > 0 then (SUM(WD.Quantity) * SD.Price) * 18 / 100 else 0 end) as [TLTaxTotal], (SUM(WD.Quantity) * SD.Price) + (case when SD.Tax > 0 then (SUM(WD.Quantity) * SD.Price) * 18 / 100 else 0 end) as [TLTotal], E.ExpeditionNumber+'/'+cast(ED.LineNumber as varchar(5)) as [ExpeditionNumber], D.DeliveryNumber+'/'+cast(DD.LineNumber as varchar(5)) as [DeliveryNumber], CT.Name as [City], PG.Name as [ProductGroup], PT.Name as [ProductType], PK.Name as [ProductKind], PKG.Name as [ProductKindGroup], SO.Name as [SalesOffice], SG.Name as [SalesGroup], PM.Name as [PaymentMethod] from SalesWaybillDetail WD inner join SalesWaybill W on W.Oid = WD.SalesWaybill inner join SalesOrderDetail SD on SD.Oid = WD.SalesOrderDetail inner join SalesOrder O on O.Oid = SD.SalesOrder inner join Contact C on C.Oid = O.Contact inner join Contact SC on SC.Oid = O.ShippingContact inner join City CT on CT.Oid = C.City inner join DistributionChannel DC on DC.Oid = O.DistributionChannel inner join SalesOffice SO on SO.Oid = O.SalesOffice inner join SalesGroup SG on SG.Oid = O.SalesGroup inner join PaymentMethod PM on PM.Oid = O.PaymentMethod inner join Product P on P.Oid = WD.Product inner join ProductGroup PG on PG.Oid = P.ProductGroup inner join ProductType PT on PT.Oid = P.ProductType inner join ProductKind PK on PK.Oid = P.ProductKind left outer join ProductKindGroup PKG on PKG.Oid = PK.ProductKindGroup inner join Unit U on U.Oid = WD.Unit inner join Unit CU on CU.Oid = WD.cUnit inner join DeliveryDetail DD on DD.Oid = WD.DeliveryDetail inner join Delivery D on D.Oid = DD.Delivery inner join ExpeditionDetail ED on ED.Oid = WD.ExpeditionDetail inner join Expedition E on E.Oid = ED.Expedition left outer join ShippingUser SU on SU.Oid = E.ShippingUser inner join Employee EM on EM.Oid = SU.Employee inner join Truck T on T.Oid = E.Truck inner join TruckDriver TD on TD.Oid = E.TruckDriver inner join [Route] R on R.Oid = E.[Route] where WD.GCRecord is null and cast(W.WaybillDate as date) between '2017-01-01' and '2017-02-28' group by W.WaybillNumber, W.WaybillDate, O.OrderNumber, SD.LineNumber, SD.Price, SD.Tax, C.Name, SC.Name, P.Name, U.Code, CU.Code, E.ExpeditionNumber, ED.LineNumber, D.DeliveryNumber, DD.LineNumber, EM.NameSurname, T.PlateNumber, TD.NameSurname, TD.CellPhone, R.Name, CT.Name, PG.Name, PT.Name, PK.Name, PKG.Name, O.SalesOrderType, DC.Name, SO.Name, SG.Name, PM.Name