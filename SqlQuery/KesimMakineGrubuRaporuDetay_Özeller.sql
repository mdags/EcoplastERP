select CMG.Name as [Kesim Makine Grubu], PG.Name as [Ürün Grubu], PT.Name as [Ürün Tipi], PK.Name as [Ürün Cinsi], PKG.Name as [Satýþ Ürün Grubu], (case when P.PrintStatus = 0 then 'Baskýlý' else 'Baskýsýz' end) as [Baský Durumu], O.OrderNumber+'/'+cast(D.LineNumber as varchar(5)) as [Sipariþ No], cast(D.LineDeliveryDate as date) as [Termin Tarihi], C.Name as [Sipariþi Veren], SC.Name as [Malý Teslim Alan], P.Code as [Malzeme Kodu], P.Name as [Malzeme Adý], SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) as [Bekleyen TÖB Miktar]
, (case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) as [Sevk Depo TÖB Miktar]
, (case when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < 0 then 0 when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) > (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) end) as [Depo Karþýlama]
, (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) - (case when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < 0 then 0 when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) > (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) end) as [Üretilecek TÖB Miktar], CMG.Capacity as [Kapasite (gün)]
, (case when CMG.Capacity > 0 then ((SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) - (case when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < 0 then 0 when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) > (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) when ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) < (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) then ((case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse in (select Oid from Warehouse where GCRecord is null and ShippingWarehouse = 1) and SalesOrderDetail in (select D1.Oid from SalesOrderDetail D1 inner join SalesOrder O1 on O1.Oid = D1.SalesOrder where D1.GCRecord is null and D1.SalesOrderStatus < 200 and O1.SalesOrderType in (0, 2, 3, 4) and D1.CuttingMachineGroup = D.CuttingMachineGroup and D1.Product = P.Oid)) end) - ((sum(SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))) over (partition by PG.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate rows unbounded preceding)) - (SUM(D.cQuantity) - (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid))))) end)) / CMG.Capacity else 0 end) as [Toplam Dolu Gün]
, (case when PG.Code = 'OM' then (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Kesim') and SalesOrderDetail = D.Oid) else (select isnull(sum(cQuantity), 0) from Store where GCRecord is null and Warehouse = (select SourceWarehouse from Station where GCRecord is null and Name = 'Kesim') and Product = P.Oid) end) as [Kesim Depo], sum(D.cQuantity) as [Sipariþ TÖB Miktar], (select isnull(sum(cQuantity), 0) from DeliveryDetailLoading where GCRecord is null and DeliveryDetail in (select Oid from DeliveryDetail where GCRecord is null and SalesOrderDetail = D.Oid)) as [Sevk Edilen TÖB Miktar] 
from SalesOrderDetail D inner join SalesOrder O on O.Oid = D.SalesOrder inner join Contact C on C.Oid = O.Contact inner join Contact SC on SC.Oid = O.ShippingContact inner join Product P on P.Oid = D.Product inner join ProductGroup PG on PG.Oid = P.ProductGroup inner join ProductType PT on PT.Oid = P.ProductType inner join ProductKind PK on PK.Oid = P.ProductKind inner join CuttingMachineGroup CMG on CMG.Oid = D.CuttingMachineGroup inner join ProductKindGroup PKG on PKG.Oid = PK.ProductKindGroup where D.GCRecord is null and D.SalesOrderStatus < 200 and (PG.Code = 'OM' or PG.Code = 'SM') and O.SalesOrderType in (0, 2, 3, 4) and D.CuttingMachineGroup = '{0}' group by D.CuttingMachineGroup, CMG.Name, CMG.Capacity, PG.Code, PG.Name, PT.Name, PK.Name, PKG.Name, P.PrintStatus, O.OrderNumber, D.Oid, D.LineNumber, D.LineDeliveryDate, C.Name, SC.Name, P.Oid, P.Code, P.Name order by PG.Name, P.Name, D.LineDeliveryDate