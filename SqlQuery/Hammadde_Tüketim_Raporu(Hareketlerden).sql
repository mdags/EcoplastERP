declare @begindate date, @enddate date
set @begindate = '2017-01-01' set @enddate = '2017-03-30'
select C.Name as [Müþteri], O.OrderNumber as [Sipariþ No], D.LineNumber as [Satýr No], 
P.Code as [Malzeme Kodu], P.Name as [Ýþin Adý], M.DocumentNumber as [Üretim Sipariþi No], (select SUM(NetQuantity) from Production where GCRecord is null and WorkOrderNumber = M.DocumentNumber and cast(ProductionDate as date) between @begindate and @enddate) as [Net Üretim], (case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P111') then sum(M.Quantity) else 0 end) - (case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P114') then sum(M.Quantity) else 0 end) as [Tüketim Miktarý], ((case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P111') then sum(M.Quantity) else 0 end) - (case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P114') then sum(M.Quantity) else 0 end)) * 100 / (select SUM(NetQuantity) from Production where GCRecord is null and WorkOrderNumber = M.DocumentNumber and cast(ProductionDate as date) between @begindate and @enddate) as [Oran(%)], U.Code as [Birimi] from Movement M inner join Product P on P.Oid = M.Product inner join ProductGroup PG on PG.Oid = P.ProductGroup inner join Unit U on U.Oid = M.Unit inner join SalesOrderDetail D on D.Oid = M.SalesOrderDetail inner join SalesOrder O on O.Oid = D.SalesOrder inner join Contact C on C.Oid = O.Contact 
where M.GCRecord is null and P.ProductGroup not in (select Oid from ProductGroup where GCRecord is null and Code in ('OM', 'SM')) and M.DocumentDate between @begindate and @enddate group by C.Name, O.OrderNumber, D.LineNumber, P.Code, P.Name, M.DocumentNumber, U.Code, M.MovementType
having ((case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P111') then sum(M.Quantity) else 0 end) - (case when M.MovementType = (select Oid from MovementType where GCRecord is null and Code = 'P114') then sum(M.Quantity) else 0 end)) > 0 
order by M.DocumentNumber 